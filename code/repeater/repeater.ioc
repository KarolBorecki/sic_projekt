#include "../common.h"
#include <Wire.h>
#include <SPI.h>

const uint32_t MY_NODE_ID = ID_W1;

#define PIN_SPI_MISO 10   // PA18 - DOPO=0
#define PIN_SPI_MOSI 8    // PA16 - DIPO=0
#define PIN_SPI_SCK  9    // PA17
#define PIN_SPI_SS   4    // PA14

volatile uint8_t spiBuffer[sizeof(DataFrame)];
volatile uint16_t spiIndex = 0;
volatile bool frameReady = false;

void setup() {
    Serial.begin(UART_BAUD_RATE);
    Wire.begin();

    // --- SPI MASTER setup ---
    pinMode(PIN_SPI_SS, OUTPUT);
    digitalWrite(PIN_SPI_SS, HIGH);   // deselect slave

    SPI.begin();                      // start SPI in MASTER mode
    SPI.beginTransaction(SPISettings(
        1'000'000,                    // clock
        MSBFIRST,
        SPI_MODE0
    ));
}

bool readSpiFrame() {
    if (frameReady) return true;

    digitalWrite(PIN_SPI_SS, LOW);

    // Odczyt pe≈Çnej ramki
    for (; spiIndex < sizeof(DataFrame); spiIndex++) {
        spiBuffer[spiIndex] = SPI.transfer(0xFF);  // dummy write
    }

    digitalWrite(PIN_SPI_SS, HIGH);

    if (spiIndex >= sizeof(DataFrame)) {
        frameReady = true;
        spiIndex = 0;
        return true;
    }

    return false;
}

void loop() {
    if (readSpiFrame()) {

        DataFrame frame;
        memcpy(&frame, (void*)spiBuffer, sizeof(DataFrame));

        // Flag reset
        frameReady = false;

        // Update routing
        frame.pathMask |= MY_NODE_ID;
        frame.crc = calculateCRC((uint8_t*)&frame, sizeof(DataFrame) - sizeof(uint16_t));

        // Routing logic
        if (MY_NODE_ID == ID_W1) {
            Serial.write((uint8_t*)&frame, sizeof(DataFrame));

            Wire.beginTransmission(W4_NR);
            Wire.write((uint8_t*)&frame, sizeof(DataFrame));
            Wire.endTransmission();
        } else if (MY_NODE_ID == ID_W2) {
            Wire.beginTransmission(W3_NR);
            Wire.write((uint8_t*)&frame, sizeof(DataFrame));
            Wire.endTransmission();

            Serial.write((uint8_t*)&frame, sizeof(DataFrame));
        }
    }
}
